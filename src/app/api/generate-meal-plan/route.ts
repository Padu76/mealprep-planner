import { NextRequest, NextResponse } from 'next/server';
import Anthropic from '@anthropic-ai/sdk';
import { FITNESS_RECIPES_DB, selectFitnessRecipes } from '../../../utils/fitness_recipes_database';
import { saveMealPlan, createUser } from '../../../utils/supabaseOperations';
import { FormData, NutritionalCalculation, GenerateMealPlanResponse } from '../../../types';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

export async function POST(request: NextRequest) {
  try {
    const formData: FormData = await request.json();
    console.log('üèãÔ∏è‚Äç‚ôÇÔ∏è Generating FITNESS meal plan with COMPLETE form data:', formData);

    // üîß CALCOLO CALORIE COMPLETAMENTE FIXATO CON ALLERGIE
    console.log('üöÄ ===== INIZIO CALCOLO CALORIE CON ALLERGIE DEBUG =====');
    console.log('üìã Allergie ricevute:', formData.allergie);
    console.log('ü•ó Preferenze ricevute:', formData.preferenze);
    
    const calc = calculateNutritionalNeedsWithAllergies(formData);
    
    console.log('üìä ===== RISULTATO CALCOLO FINALE =====');
    console.log('üìä Fixed nutritional calculations:', calc);
    console.log('üî• CALORIE FINALI CALCOLATE:', calc.dailyCalories);
    console.log('‚ö†Ô∏è ALLERGIE PROCESSATE:', calc.debugInfo.input.allergie);
    console.log('ü•ó PREFERENZE PROCESSATE:', calc.debugInfo.input.preferenze);
    console.log('üöÄ ===== FINE CALCOLO CALORIE DEBUG =====');

    // üö® VERIFICA SICUREZZA CALORIE
    if (!calc.isSafe) {
      console.error('üö® UNSAFE CALORIE CALCULATION:', calc);
      return NextResponse.json({
        success: false,
        error: `Calcolo calorie non sicuro: ${calc.dailyCalories} kcal/giorno. Verifica i dati inseriti.`,
        debug: calc
      }, { status: 400 });
    }

    // üë§ SALVA/AGGIORNA UTENTE IN DATABASE
    console.log('üë§ ===== GESTIONE UTENTE DATABASE =====');
    try {
      const userResult = await createUser({
        nome: formData.nome,
        email: formData.email,
        telefono: formData.telefono
      });
      
      if (userResult.error) {
        console.warn('‚ö†Ô∏è User creation warning:', userResult.error.message);
      } else {
        console.log('‚úÖ User created/updated successfully:', userResult.data?.id);
      }
    } catch (userError) {
      console.error('‚ùå User database error:', userError);
      // Continuiamo anche se il salvataggio utente fallisce
    }

    // üéØ LOG DETTAGLIATO PER DEBUG CON ALLERGIE
    console.log('üìù DETAILED CALCULATION DEBUG WITH ALLERGIES:');
    console.log('- Raw obiettivo from form:', formData.obiettivo);
    console.log('- Raw attivita from form:', formData.attivita);
    console.log('- Raw allergie from form:', formData.allergie);
    console.log('- Raw preferenze from form:', formData.preferenze);
    console.log('- Normalized goal:', calc.goal);
    console.log('- Normalized activity:', calc.activity);
    console.log('- Processed allergie:', calc.debugInfo.input.allergie);
    console.log('- Processed preferenze:', calc.debugInfo.input.preferenze);
    console.log('- Goal factor used:', calc.debugInfo.goalFactor);
    console.log('- Activity factor used:', calc.debugInfo.activityFactor);

    // üáÆüáπ SELEZIONE RICETTE FITNESS CON FILTRI ALLERGIE/PREFERENZE
    console.log('üáÆüáπ ===== SELEZIONE RICETTE FITNESS CON FILTRI =====');
    const fitnessRecipes = generateFitnessBasedPlanWithFilters(formData, calc);
    console.log('‚úÖ Ricette fitness selezionate (post-filtri):', fitnessRecipes.totalRecipes);
    console.log('üö´ Ricette filtrate per allergie:', fitnessRecipes.filteredForAllergies);
    console.log('‚úÖ Ricette matchate per preferenze:', fitnessRecipes.matchedPreferences);

    // ü§ñ PROVA CLAUDE AI CON ALLERGIE E PREFERENZE
    if (!process.env.ANTHROPIC_API_KEY) {
      console.log('‚ö†Ô∏è ANTHROPIC_API_KEY not found, using fitness fallback');
      const fallbackResponse = await generateFitnessBasedResponseWithDB(formData, calc, fitnessRecipes);
      return fallbackResponse;
    }

    try {
      console.log('ü§ñ Calling Claude AI with FITNESS database + ALLERGIES + PREFERENCES...');
      
      const prompt = createAllergyAwarePrompt(formData, calc, fitnessRecipes);
      
      const message = await anthropic.messages.create({
        model: "claude-3-haiku-20240307",
        max_tokens: 4000,
        temperature: 0.8,
        messages: [
          {
            role: "user",
            content: prompt
          }
        ]
      });

      const aiResponse = message.content[0];
      if (aiResponse.type !== 'text') {
        throw new Error('Invalid AI response type');
      }

      console.log('‚úÖ Claude AI FITNESS response with allergies received');

      // üíæ SALVA MEAL PLAN NEL DATABASE
      console.log('üíæ ===== SALVATAGGIO MEAL PLAN =====');
      let mealPlanId: string | undefined;

      try {
        const mealPlanData = {
          nome_utente: formData.nome,
          email_utente: formData.email,
          telefono_utente: formData.telefono,
          eta: calc.debugInfo.input.age,
          sesso: calc.debugInfo.input.gender,
          peso: calc.debugInfo.input.weight,
          altezza: calc.debugInfo.input.height,
          modalita: formData.modalita || 'guidata',
          attivita: calc.activity,
          obiettivo: calc.goal,
          durata: calc.numDays,
          pasti: calc.numMeals,
          varieta: formData.varieta || 'diversi',
          allergie: formData.allergie || [],
          preferenze: formData.preferenze || [],
          bmr: calc.bmr,
          tdee: calc.tdee,
          calorie_target: calc.dailyCalories,
          distribuzione_pasti: calc.mealCalories,
          piano_completo: aiResponse.text,
          generato_con_ai: true,
          fitness_optimized: true,
          total_recipes: fitnessRecipes.totalRecipes,
          calorie_manuali: formData.modalita === 'esperto' ? parseInt(formData.calorie_totali || '0') : undefined,
          proteine_manuali: formData.modalita === 'esperto' ? parseInt(formData.proteine_totali || '0') : undefined,
          carboidrati_manuali: formData.modalita === 'esperto' ? parseInt(formData.carboidrati_totali || '0') : undefined,
          grassi_manuali: formData.modalita === 'esperto' ? parseInt(formData.grassi_totali || '0') : undefined,
          status: 'generato' as const
        };

        const saveResult = await saveMealPlan(mealPlanData);
        
        if (saveResult.error) {
          console.error('‚ùå Meal plan save error:', saveResult.error);
        } else {
          console.log('‚úÖ Meal plan saved successfully:', saveResult.data?.id);
          mealPlanId = saveResult.data?.id;
        }
      } catch (dbError) {
        console.error('‚ùå Database error during meal plan save:', dbError);
        // Continuiamo anche se il salvataggio fallisce
      }

      const response: GenerateMealPlanResponse = {
        success: true,
        piano: aiResponse.text,
        message: 'Piano alimentare FITNESS generato con ricette italiane e filtri allergie/preferenze!',
        meal_plan_id: mealPlanId,
        metadata: {
          bmr: calc.bmr,
          tdee: calc.tdee,
          dailyTarget: calc.dailyCalories,
          mealDistribution: calc.mealCalories,
          isCalorieSafe: calc.isSafe,
          aiGenerated: true,
          fitnessOptimized: true,
          totalRecipes: fitnessRecipes.totalRecipes,
          debugInfo: calc.debugInfo
        }
      };

      return NextResponse.json(response);

    } catch (aiError) {
      console.error('‚ùå Claude AI error:', aiError);
      console.log('üîÑ Falling back to FITNESS template with allergies...');
      const fallbackResponse = await generateFitnessBasedResponseWithDB(formData, calc, fitnessRecipes);
      return fallbackResponse;
    }

  } catch (error) {
    console.error('‚ùå General error:', error);
    return NextResponse.json({
      success: false,
      error: 'Errore interno del server',
      details: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 });
  }
}

// üáÆüáπ NUOVA FUNZIONE: SELEZIONE RICETTE CON FILTRI ALLERGIE/PREFERENZE
function generateFitnessBasedPlanWithFilters(formData: FormData, calc: NutritionalCalculation) {
  console.log('üèãÔ∏è‚Äç‚ôÇÔ∏è Generating fitness-based meal selection WITH FILTERS...');
  
  const numDays = calc.numDays;
  const numMeals = calc.numMeals;
  const objetivo = calc.goal;
  const allergie = formData.allergie || [];
  const preferenze = formData.preferenze || [];
  
  console.log('üö´ Filtering for allergies:', allergie);
  console.log('‚úÖ Matching for preferences:', preferenze);
  
  const selectedRecipes = {
    colazione: [],
    pranzo: [],
    cena: [],
    spuntino: [],
    totalRecipes: 0,
    filteredForAllergies: 0,
    matchedPreferences: 0
  };

  // Seleziona ricette per ogni giorno con filtri
  for (let day = 0; day < numDays; day++) {
    // Colazione FITNESS con filtri
    const colazioneOptions = selectFitnessRecipes('colazione', objetivo, 1, preferenze, allergie);
    if (colazioneOptions.length > 0) {
      const selected = colazioneOptions[day % colazioneOptions.length];
      selectedRecipes.colazione.push(selected);
      selectedRecipes.totalRecipes++;
      
      // Conta filtri applicati
      if (allergie.length > 0) selectedRecipes.filteredForAllergies++;
      if (preferenze.length > 0 && hasMatchingPreferences(selected, preferenze)) {
        selectedRecipes.matchedPreferences++;
      }
    }

    // Pranzo FITNESS con filtri
    const pranzoOptions = selectFitnessRecipes('pranzo', objetivo, 1, preferenze, allergie);
    if (pranzoOptions.length > 0) {
      const selected = pranzoOptions[day % pranzoOptions.length];
      selectedRecipes.pranzo.push(selected);
      selectedRecipes.totalRecipes++;
      
      if (allergie.length > 0) selectedRecipes.filteredForAllergies++;
      if (preferenze.length > 0 && hasMatchingPreferences(selected, preferenze)) {
        selectedRecipes.matchedPreferences++;
      }
    }

    // Cena FITNESS con filtri
    const cenaOptions = selectFitnessRecipes('cena', objetivo, 1, preferenze, allergie);
    if (cenaOptions.length > 0) {
      const selected = cenaOptions[day % cenaOptions.length];
      selectedRecipes.cena.push(selected);
      selectedRecipes.totalRecipes++;
      
      if (allergie.length > 0) selectedRecipes.filteredForAllergies++;
      if (preferenze.length > 0 && hasMatchingPreferences(selected, preferenze)) {
        selectedRecipes.matchedPreferences++;
      }
    }

    // Spuntini FITNESS se richiesti con filtri
    if (numMeals >= 4) {
      const spuntinoOptions = selectFitnessRecipes('spuntino', objetivo, 1, preferenze, allergie);
      if (spuntinoOptions.length > 0) {
        const selected = spuntinoOptions[day % spuntinoOptions.length];
        selectedRecipes.spuntino.push(selected);
        selectedRecipes.totalRecipes++;
        
        if (allergie.length > 0) selectedRecipes.filteredForAllergies++;
        if (preferenze.length > 0 && hasMatchingPreferences(selected, preferenze)) {
          selectedRecipes.matchedPreferences++;
        }
      }
    }
  }

  console.log('üéØ FITNESS recipes selected with filters:', selectedRecipes.totalRecipes);
  console.log('üö´ Total allergy-filtered:', selectedRecipes.filteredForAllergies);
  console.log('‚úÖ Total preference-matched:', selectedRecipes.matchedPreferences);
  
  return selectedRecipes;
}

// Helper function per check preferenze
function hasMatchingPreferences(recipe: any, preferenze: string[]): boolean {
  if (!preferenze || preferenze.length === 0) return false;
  if (!recipe || !recipe.ingredienti) return false;
  
  const ingredientiLower = recipe.ingredienti.map((ing: string) => ing.toLowerCase());
  return preferenze.some(pref => 
    ingredientiLower.some(ing => ing.includes(pref.toLowerCase()))
  );
}

// ü§ñ PROMPT AI FITNESS-OTTIMIZZATO CON ALLERGIE E PREFERENZE
function createAllergyAwarePrompt(formData: FormData, calc: NutritionalCalculation, fitnessRecipes: any): string {
  const allergieText = formData.allergie && formData.allergie.length > 0 ? 
    `\nüö´ ALLERGIE E INTOLLERANZE: ${formData.allergie.join(', ')} - EVITARE ASSOLUTAMENTE` : 
    '\n‚úÖ ALLERGIE: Nessuna allergia dichiarata';
  
  const preferenzeText = formData.preferenze && formData.preferenze.length > 0 ? 
    `\nü•ó PREFERENZE ALIMENTARI: ${formData.preferenze.join(', ')} - PRIVILEGIARE QUANDO POSSIBILE` : 
    '\nüîß PREFERENZE: Nessuna preferenza specifica dichiarata';

  // Crea esempi di ricette dal database
  const ricetteEsempi = [
    ...fitnessRecipes.colazione.slice(0, 2),
    ...fitnessRecipes.pranzo.slice(0, 2),
    ...fitnessRecipes.cena.slice(0, 2),
    ...fitnessRecipes.spuntino.slice(0, 1)
  ].map((ricetta: any) => {
    if (!ricetta) return '';
    return `"${ricetta.nome}" (${ricetta.calorie} kcal, ${ricetta.proteine}g prot)`;
  }).filter(Boolean).join(', ');

  return `üèãÔ∏è‚Äç‚ôÇÔ∏è NUTRIZIONISTA FITNESS AI - PIANO ITALIANO CON FILTRI ALLERGIE/PREFERENZE

üë§ DATI UTENTE FITNESS:
Nome: ${formData.nome}
Et√†: ${calc.debugInfo.input.age} anni
Sesso: ${calc.debugInfo.input.gender}
Peso: ${calc.debugInfo.input.weight} kg
Altezza: ${calc.debugInfo.input.height} cm
Attivit√†: ${calc.debugInfo.input.activity}
Obiettivo FITNESS: ${calc.debugInfo.input.goal}${allergieText}${preferenzeText}

üìä CALCOLI NUTRIZIONALI PRECISI:
BMR: ${calc.bmr} kcal (${calc.debugInfo.bmrFormula})
TDEE: ${calc.tdee} kcal (BMR √ó ${calc.debugInfo.activityFactor})
Target giornaliero: ${calc.dailyCalories} kcal (TDEE √ó ${calc.debugInfo.goalFactor})

üçΩÔ∏è DISTRIBUZIONE PASTI OTTIMIZZATA:
${Object.entries(calc.mealCalories).map(([meal, cal]) => `${meal}: ${cal} kcal`).join('\n')}

üáÆüáπ DATABASE RICETTE FITNESS CON FILTRI:
Ricette italiane fitness-ottimizzate disponibili: ${fitnessRecipes.totalRecipes}
Ricette filtrate per allergie: ${fitnessRecipes.filteredForAllergies}
Ricette matchate per preferenze: ${fitnessRecipes.matchedPreferences}
Esempi dal database: ${ricetteEsempi}

üö® ATTENZIONE ALLERGIE E INTOLLERANZE:
${formData.allergie && formData.allergie.length > 0 ? 
  `‚ö†Ô∏è L'utente ha dichiarato allergie a: ${formData.allergie.join(', ')}
EVITA ASSOLUTAMENTE questi ingredienti e tutti i loro derivati.
Controlla attentamente ogni ricetta per escludere completamente questi alimenti.
Se un ingrediente potrebbe contenere tracce, SCARTALO.` :
  '‚úÖ Nessuna allergia dichiarata, usa tutte le ricette disponibili.'
}

ü•ó PREFERENZE ALIMENTARI:
${formData.preferenze && formData.preferenze.length > 0 ? 
  `‚ú® L'utente preferisce: ${formData.preferenze.join(', ')}
PRIVILEGIA ricette che includono questi ingredienti quando possibile.
Cerca di incorporare queste preferenze in ogni pasto della giornata.` :
  'üîß Nessuna preferenza specifica, usa variet√† bilanciata di ingredienti.'
}

üéØ OBIETTIVO SPECIFICO FITNESS:
${calc.goal === 'dimagrimento' ? 
  '‚Ä¢ Focus: Deficit calorico, alta proteina, bassa densit√† calorica\n‚Ä¢ Priorit√†: Ricette lean, verdure, proteine magre\n‚Ä¢ Evita: Fritture, dolci, carboidrati raffinati' :
  calc.goal === 'aumento-massa' ?
  '‚Ä¢ Focus: Surplus calorico, costruzione muscolare, recovery\n‚Ä¢ Priorit√†: Ricette caloriche, carboidrati, proteine complete\n‚Ä¢ Include: Frutta secca, avocado, cereali integrali' :
  '‚Ä¢ Focus: Mantenimento, bilanciamento, sostenibilit√†\n‚Ä¢ Priorit√†: Ricette bilanciate, variet√† nutrizionale\n‚Ä¢ Equilibra: Tutti i macronutrienti'
}

üî• REQUISITI FITNESS SPECIFICI CON FILTRI:
1. Usa SOLO ricette italiane con ingredienti fitness-friendly
2. RISPETTA ASSOLUTAMENTE le allergie dichiarate - ZERO TOLLERANZA
3. PRIVILEGIA le preferenze alimentari quando possibile
4. Ogni ricetta deve avere almeno 20g di proteine (colazione/cena) o 25g (pranzo)
5. Bilancia macro per l'obiettivo specifico
6. Includi preparazione, ingredienti e macro dettagliati
7. Ricette diverse ogni giorno (variet√† totale)
8. Considera timing nutrizionale per performance

üìã FORMATO RICHIESTO:
GIORNO X:
üåÖ COLAZIONE (${calc.mealCalories.colazione || 400} kcal): [Nome Ricetta Italiana Fitness]
- Ingredienti: [lista dettagliata con quantit√†] ‚úÖ VERIFICATI PER ALLERGIE
- Preparazione: [step-by-step fitness-friendly]
- Macro: P: XXg | C: XXg | G: XXg | Fitness Score: XX/100
- Note Allergie: [Conferma ingredienti sicuri]

‚òÄÔ∏è PRANZO (${calc.mealCalories.pranzo || 500} kcal): [Nome Ricetta Italiana Fitness]
[stesso formato con verifica allergie]

üåô CENA (${calc.mealCalories.cena || 400} kcal): [Nome Ricetta Italiana Fitness]
[stesso formato con verifica allergie]

${calc.mealCalories.spuntino1 ? `üçé SPUNTINO (${calc.mealCalories.spuntino1} kcal): [Nome Spuntino Fitness]
[stesso formato con verifica allergie]` : ''}

‚ö†Ô∏è CONTROLLO FINALE ALLERGIE:
Prima di finalizzare ogni ricetta, verifica che NON contenga:
${formData.allergie && formData.allergie.length > 0 ? formData.allergie.join(', ') : 'Nessuna allergia da controllare'}

‚ú® BONUS PREFERENZE:
Cerca di includere quando possibile:
${formData.preferenze && formData.preferenze.length > 0 ? formData.preferenze.join(', ') : 'Variet√† bilanciata'}

üí™ CREA UN PIANO CHE UN FITNESS ENTHUSIAST ITALIANO CON QUESTE SPECIFICHE ESIGENZE APPREZZEREBBE!
Usa ricette che combinano tradizione italiana con obiettivi fitness moderni, rispettando rigorosamente allergie e privilegiando preferenze.`;
}

// üáÆüáπ FALLBACK FITNESS CON DATABASE E ALLERGIE
async function generateFitnessBasedResponseWithDB(formData: FormData, calc: NutritionalCalculation, fitnessRecipes: any) {
  const numDays = calc.numDays;
  const numMeals = calc.numMeals;
  
  let fitnessPlanned = `üèãÔ∏è‚Äç‚ôÇÔ∏è PIANO FITNESS ITALIANO - RICETTE DATABASE CON FILTRI ALLERGIE/PREFERENZE
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

üë§ PROFILO FITNESS:
Nome: ${formData.nome}
Et√†: ${calc.debugInfo.input.age} anni | Sesso: ${calc.debugInfo.input.gender}
Peso: ${calc.debugInfo.input.weight} kg | Altezza: ${calc.debugInfo.input.height} cm
Attivit√†: ${calc.debugInfo.input.activity} | Obiettivo: ${calc.debugInfo.input.goal}

üö´ ALLERGIE: ${formData.allergie && formData.allergie.length > 0 ? formData.allergie.join(', ') : 'Nessuna'}
ü•ó PREFERENZE: ${formData.preferenze && formData.preferenze.length > 0 ? formData.preferenze.join(', ') : 'Nessuna'}

üìä CALCOLI SCIENTIFICI:
BMR: ${calc.bmr} kcal/giorno
TDEE: ${calc.tdee} kcal/giorno
Target: ${calc.dailyCalories} kcal/giorno

üçΩÔ∏è DISTRIBUZIONE MACRO-OTTIMIZZATA:
${Object.entries(calc.mealCalories).map(([meal, cal]) => `${meal}: ${cal} kcal`).join('\n')}

üáÆüáπ RICETTE FITNESS ITALIANE FILTRATE: ${fitnessRecipes.totalRecipes}
üö´ Filtrate per allergie: ${fitnessRecipes.filteredForAllergies}
‚úÖ Matchate per preferenze: ${fitnessRecipes.matchedPreferences}

‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üìÖ PROGRAMMA FITNESS CON FILTRI:

`;

  // Genera giorni con ricette dal database FITNESS filtrate
  for (let day = 1; day <= numDays; day++) {
    const dayIndex = day - 1;
    
    fitnessPlanned += `üóìÔ∏è GIORNO ${day}:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

`;

    // COLAZIONE FITNESS con check allergie
    const colazione = fitnessRecipes.colazione[dayIndex];
    if (colazione) {
      const allergieCheck = formData.allergie && formData.allergie.length > 0 ? 
        `‚úÖ Verificato per allergie: ${formData.allergie.join(', ')}` : 
        '‚úÖ Nessuna allergia da controllare';

      fitnessPlanned += `üåÖ COLAZIONE (${calc.mealCalories.colazione} kcal):
Nome: ${colazione.nome}
Ingredienti: ${colazione.ingredienti.join(', ')}
Preparazione: ${colazione.preparazione}
Macro: P: ${colazione.proteine}g | C: ${colazione.carboidrati}g | G: ${colazione.grassi}g
Fitness Score: ${colazione.fitnessScore}/100 ‚≠ê
Tempo: ${colazione.tempo} | Porzioni: ${colazione.porzioni}
${allergieCheck}

`;
    }

    // PRANZO FITNESS con check allergie
    const pranzo = fitnessRecipes.pranzo[dayIndex];
    if (pranzo) {
      const allergieCheck = formData.allergie && formData.allergie.length > 0 ? 
        `‚úÖ Verificato per allergie: ${formData.allergie.join(', ')}` : 
        '‚úÖ Nessuna allergia da controllare';

      fitnessPlanned += `‚òÄÔ∏è PRANZO (${calc.mealCalories.pranzo} kcal):
Nome: ${pranzo.nome}
Ingredienti: ${pranzo.ingredienti.join(', ')}
Preparazione: ${pranzo.preparazione}
Macro: P: ${pranzo.proteine}g | C: ${pranzo.carboidrati}g | G: ${pranzo.grassi}g
Fitness Score: ${pranzo.fitnessScore}/100 ‚≠ê
Tempo: ${pranzo.tempo} | Porzioni: ${pranzo.porzioni}
${allergieCheck}

`;
    }

    // CENA FITNESS con check allergie
    const cena = fitnessRecipes.cena[dayIndex];
    if (cena) {
      const allergieCheck = formData.allergie && formData.allergie.length > 0 ? 
        `‚úÖ Verificato per allergie: ${formData.allergie.join(', ')}` : 
        '‚úÖ Nessuna allergia da controllare';

      fitnessPlanned += `üåô CENA (${calc.mealCalories.cena} kcal):
Nome: ${cena.nome}
Ingredienti: ${cena.ingredienti.join(', ')}
Preparazione: ${cena.preparazione}
Macro: P: ${cena.proteine}g | C: ${cena.carboidrati}g | G: ${cena.grassi}g
Fitness Score: ${cena.fitnessScore}/100 ‚≠ê
Tempo: ${cena.tempo} | Porzioni: ${cena.porzioni}
${allergieCheck}

`;
    }

    // SPUNTINO FITNESS se richiesto con check allergie
    if (numMeals >= 4 && calc.mealCalories.spuntino1) {
      const spuntino = fitnessRecipes.spuntino[dayIndex];
      if (spuntino) {
        const allergieCheck = formData.allergie && formData.allergie.length > 0 ? 
          `‚úÖ Verificato per allergie: ${formData.allergie.join(', ')}` : 
          '‚úÖ Nessuna allergia da controllare';

        fitnessPlanned += `üçé SPUNTINO (${calc.mealCalories.spuntino1} kcal):
Nome: ${spuntino.nome}
Ingredienti: ${spuntino.ingredienti.join(', ')}
Preparazione: ${spuntino.preparazione}
Macro: P: ${spuntino.proteine}g | C: ${spuntino.carboidrati}g | G: ${spuntino.grassi}g
Fitness Score: ${spuntino.fitnessScore}/100 ‚≠ê
Target: ${spuntino.macroTarget}
${allergieCheck}

`;
      }
    }

    fitnessPlanned += `üí™ TOTALE GIORNO ${day}: ${calc.dailyCalories} kcal
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

`;
  }

  // Sezione allergie e preferenze specifica
  fitnessPlanned += `‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

üö® GESTIONE ALLERGIE E PREFERENZE:

üö´ ALLERGIE DICHIARATE:
${formData.allergie && formData.allergie.length > 0 ? 
  formData.allergie.map(a => `‚Ä¢ ${a}: EVITATO in tutte le ricette`).join('\n') :
  '‚úÖ Nessuna allergia dichiarata'
}

ü•ó PREFERENZE PRIVILEGIATE:
${formData.preferenze && formData.preferenze.length > 0 ? 
  formData.preferenze.map(p => `‚Ä¢ ${p}: INCLUSO quando possibile`).join('\n') :
  'üîß Nessuna preferenza specifica'
}

‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üèãÔ∏è‚Äç‚ôÇÔ∏è CONSIGLI FITNESS SPECIFICI:
‚Ä¢ Idratazione: 35-40ml per kg di peso corporeo (${Math.round(calc.debugInfo.input.weight * 35)}ml/giorno)
‚Ä¢ Timing proteine: 20-25g ogni 3-4 ore per sintesi proteica ottimale
‚Ä¢ Pre-workout: Carboidrati 30-60 min prima dell'allenamento
‚Ä¢ Post-workout: Proteine + carboidrati entro 30 min dal training
‚Ä¢ Riposo: 7-9 ore di sonno per recovery e crescita muscolare

üìä ANALISI NUTRIZIONALE FITNESS:
‚Ä¢ Calorie totali piano: ${calc.dailyCalories * numDays} kcal
‚Ä¢ Proteine target: ${Math.round(calc.debugInfo.input.weight * 1.6)}g/giorno (1.6g/kg)
‚Ä¢ Carboidrati: ${Math.round(calc.dailyCalories * 0.45 / 4)}g/giorno (45% energia)
‚Ä¢ Grassi: ${Math.round(calc.dailyCalories * 0.25 / 9)}g/giorno (25% energia)
‚Ä¢ Rapporto P/C/G ottimale per ${calc.goal}

üéØ OBIETTIVO SPECIFICO - ${calc.goal.toUpperCase()}:
${calc.goal === 'dimagrimento' ? 
  '‚Ä¢ Deficit calorico sostenibile del 15%\n‚Ä¢ Mantenimento massa magra con proteine elevate\n‚Ä¢ Ingredienti a bassa densit√† calorica\n‚Ä¢ Focus su saziet√† e controllo insulinico' :
  calc.goal === 'aumento-massa' ?
  '‚Ä¢ Surplus calorico del 15% per crescita muscolare\n‚Ä¢ Proteine complete per sintesi proteica\n‚Ä¢ Carboidrati per energy e recovery\n‚Ä¢ Timing nutrizionale per performance' :
  '‚Ä¢ Bilanciamento calorico per composizione corporea\n‚Ä¢ Sostenibilit√† a lungo termine\n‚Ä¢ Variet√† nutrizionale per salute\n‚Ä¢ Flessibilit√† per stile di vita attivo'
}

‚úÖ Piano FITNESS generato il ${new Date().toLocaleDateString('it-IT')}
üáÆüáπ Ricette italiane ottimizzate per obiettivi fitness
üö´ Filtrato per allergie: ${formData.allergie?.join(', ') || 'nessuna'}
ü•ó Ottimizzato per preferenze: ${formData.preferenze?.join(', ') || 'nessuna'}
üî¨ Basato su science nutrizionale e database ricette fitness`;

  // üíæ SALVA ANCHE IL FALLBACK NEL DATABASE
  let mealPlanId: string | undefined;

  try {
    const mealPlanData = {
      nome_utente: formData.nome,
      email_utente: formData.email,
      telefono_utente: formData.telefono,
      eta: calc.debugInfo.input.age,
      sesso: calc.debugInfo.input.gender,
      peso: calc.debugInfo.input.weight,
      altezza: calc.debugInfo.input.height,
      modalita: formData.modalita || 'guidata',
      attivita: calc.activity,
      obiettivo: calc.goal,
      durata: calc.numDays,
      pasti: calc.numMeals,
      varieta: formData.varieta || 'diversi',
      allergie: formData.allergie || [],
      preferenze: formData.preferenze || [],
      bmr: calc.bmr,
      tdee: calc.tdee,
      calorie_target: calc.dailyCalories,
      distribuzione_pasti: calc.mealCalories,
      piano_completo: fitnessPlanned,
      generato_con_ai: false,
      fitness_optimized: true,
      total_recipes: fitnessRecipes.totalRecipes,
      calorie_manuali: formData.modalita === 'esperto' ? parseInt(formData.calorie_totali || '0') : undefined,
      proteine_manuali: formData.modalita === 'esperto' ? parseInt(formData.proteine_totali || '0') : undefined,
      carboidrati_manuali: formData.modalita === 'esperto' ? parseInt(formData.carboidrati_totali || '0') : undefined,
      grassi_manuali: formData.modalita === 'esperto' ? parseInt(formData.grassi_totali || '0') : undefined,
      status: 'generato' as const
    };

    const saveResult = await saveMealPlan(mealPlanData);
    
    if (saveResult.error) {
      console.error('‚ùå Fallback meal plan save error:', saveResult.error);
    } else {
      console.log('‚úÖ Fallback meal plan saved successfully:', saveResult.data?.id);
      mealPlanId = saveResult.data?.id;
    }
  } catch (dbError) {
    console.error('‚ùå Database error during fallback meal plan save:', dbError);
  }

  const response: GenerateMealPlanResponse = {
    success: true,
    piano: fitnessPlanned,
    message: 'Piano FITNESS con ricette italiane e filtri allergie/preferenze generato!',
    meal_plan_id: mealPlanId,
    metadata: {
      bmr: calc.bmr,
      tdee: calc.tdee,
      dailyTarget: calc.dailyCalories,
      mealDistribution: calc.mealCalories,
      isCalorieSafe: calc.isSafe,
      fitnessOptimized: true,
      totalRecipes: fitnessRecipes.totalRecipes,
      debugInfo: calc.debugInfo
    }
  };

  return NextResponse.json(response);
}

// üîß FUNZIONE CALCOLO CALORIE AGGIORNATA CON ALLERGIE
function calculateNutritionalNeedsWithAllergies(formData: FormData): NutritionalCalculation {
  console.log('üìã ===== INIZIO FUNZIONE CALCOLO CON ALLERGIE =====');
  console.log('üìã DEBUG - Raw form data RICEVUTO:', JSON.stringify(formData, null, 2));

  // üîß NORMALIZZAZIONE DATI CON ALLERGIE
  console.log('üîß ===== FASE 1: NORMALIZZAZIONE DATI CON ALLERGIE =====');
  const normalizedData = normalizeFormDataWithAllergies(formData);
  console.log('üìä Normalized data RISULTATO:', JSON.stringify(normalizedData, null, 2));

  const { age, weight, height, gender, activity, goal, numDays, numMeals, allergie, preferenze } = normalizedData;
  
  console.log('üìã DATI ESTRATTI PER CALCOLO:');
  console.log('- Et√†:', age);
  console.log('- Peso:', weight);
  console.log('- Altezza:', height);
  console.log('- Sesso:', gender);
  console.log('- Attivit√†:', activity);
  console.log('- Obiettivo:', goal);
  console.log('- Allergie:', allergie);
  console.log('- Preferenze:', preferenze);

  // üßÆ CALCOLO BMR - Harris-Benedict (INVARIATO)
  console.log('üßÆ ===== FASE 2: CALCOLO BMR =====');
  let bmr;
  if (gender === 'maschio') {
    console.log('üë® Usando formula MASCHIO: 88.362 + (13.397 √ó peso) + (4.799 √ó altezza) - (5.677 √ó et√†)');
    console.log(`üë® Calcolo: 88.362 + (13.397 √ó ${weight}) + (4.799 √ó ${height}) - (5.677 √ó ${age})`);
    const part1 = 88.362;
    const part2 = 13.397 * weight;
    const part3 = 4.799 * height;
    const part4 = 5.677 * age;
    console.log(`üë® Step by step: ${part1} + ${part2} + ${part3} - ${part4}`);
    bmr = part1 + part2 + part3 - part4;
  } else {
    console.log('üë© Usando formula FEMMINA: 447.593 + (9.247 √ó peso) + (3.098 √ó altezza) - (4.330 √ó et√†)');
    console.log(`üë© Calcolo: 447.593 + (9.247 √ó ${weight}) + (3.098 √ó ${height}) - (4.330 √ó ${age})`);
    const part1 = 447.593;
    const part2 = 9.247 * weight;
    const part3 = 3.098 * height;
    const part4 = 4.330 * age;
    console.log(`üë© Step by step: ${part1} + ${part2} + ${part3} - ${part4}`);
    bmr = part1 + part2 + part3 - part4;
  }

  console.log('üí° BMR CALCOLATO:', bmr);

  // üèÉ‚Äç‚ôÇÔ∏è FATTORI ATTIVIT√Ä - MAPPING CORRETTO E COMPLETO
  console.log('üèÉ‚Äç‚ôÇÔ∏è ===== FASE 3: FATTORE ATTIVIT√Ä =====');
  const activityFactors: { [key: string]: number } = {
    'sedentario': 1.2,
    'leggero': 1.375,
    'moderato': 1.55,
    'intenso': 1.725,
    'molto_intenso': 1.9
  };

  console.log('üèÉ‚Äç‚ôÇÔ∏è Activity factors disponibili:', activityFactors);
  console.log('üèÉ‚Äç‚ôÇÔ∏è Activity ricevuto:', activity);
  
  const activityFactor = activityFactors[activity] || 1.375; // Default leggero
  console.log('üèÉ‚Äç‚ôÇÔ∏è Activity factor SCELTO:', activityFactor, 'per activity:', activity);
  
  if (!activityFactors[activity]) {
    console.warn('‚ö†Ô∏è ATTENZIONE: Activity non trovato, usando default 1.375');
  }

  const tdee = bmr * activityFactor;
  console.log(`üî• TDEE CALCULATION: ${bmr} √ó ${activityFactor} = ${tdee}`);

  // üéØ FATTORI OBIETTIVO - I TUOI 3 PARAMETRI
  console.log('üéØ ===== FASE 4: FATTORE OBIETTIVO =====');
  const goalFactors: { [key: string]: number } = {
    'dimagrimento': 0.85,        // ‚Üì Toglie calorie
    'mantenimento': 1.0,         // ‚Üì Tiene calcolo
    'aumento-massa': 1.15        // ‚Üë Aumenta calorie
  };

  console.log('üéØ Goal factors disponibili:', goalFactors);
  console.log('üéØ Goal ricevuto:', goal);
  
  const goalFactor = goalFactors[goal] || 1.0; // Default mantenimento
  console.log('üéØ Goal factor SCELTO:', goalFactor, 'per goal:', goal);
  
  if (!goalFactors[goal]) {
    console.warn('‚ö†Ô∏è ATTENZIONE: Goal non trovato, usando default 1.0 (mantenimento)');
  }

  const dailyCalories = Math.round(tdee * goalFactor);
  console.log(`‚úÖ CALCOLO FINALE: ${tdee} √ó ${goalFactor} = ${dailyCalories} kcal`);
  
  console.log('üî• ===== RIEPILOGO CALCOLO COMPLETO CON ALLERGIE =====');
  console.log(`üî• BMR: ${Math.round(bmr)} kcal`);
  console.log(`üî• TDEE: ${Math.round(tdee)} kcal (BMR √ó ${activityFactor})`);
  console.log(`üî• DAILY CALORIES: ${dailyCalories} kcal (TDEE √ó ${goalFactor})`);
  console.log(`üö´ ALLERGIE: ${allergie.join(', ') || 'Nessuna'}`);
  console.log(`ü•ó PREFERENZE: ${preferenze.join(', ') || 'Nessuna'}`);
  console.log('üî• ===== FINE RIEPILOGO =====');

  // üçΩÔ∏è DISTRIBUZIONE PASTI
  const mealDistributions: { [key: number]: { [key: string]: number } } = {
    2: { colazione: 0.40, pranzo: 0.60 },
    3: { colazione: 0.30, pranzo: 0.40, cena: 0.30 },
    4: { colazione: 0.25, pranzo: 0.35, cena: 0.30, spuntino1: 0.10 },
    5: { colazione: 0.25, pranzo: 0.35, cena: 0.25, spuntino1: 0.10, spuntino2: 0.05 },
    6: { colazione: 0.20, pranzo: 0.30, cena: 0.25, spuntino1: 0.10, spuntino2: 0.10, spuntino3: 0.05 },
    7: { colazione: 0.20, pranzo: 0.25, cena: 0.25, spuntino1: 0.10, spuntino2: 0.10, spuntino3: 0.05, spuntino4: 0.05 }
  };

  const distribution = mealDistributions[numMeals] || mealDistributions[3];
  const mealCalories: { [key: string]: number } = {};
  
  Object.keys(distribution).forEach(meal => {
    mealCalories[meal] = Math.round(dailyCalories * distribution[meal]);
  });

  console.log('üçΩÔ∏è Meal distribution:', mealCalories);

  // üö® CONTROLLI SICUREZZA
  const isSafe = dailyCalories >= 1200 && dailyCalories <= 3500;
  const isRealistic = bmr > 1000 && bmr < 2500 && tdee > 1200 && tdee < 4000;

  return {
    bmr: Math.round(bmr),
    tdee: Math.round(tdee),
    dailyCalories,
    mealCalories,
    numDays,
    numMeals,
    isSafe: isSafe && isRealistic,
    goal,
    activity,
    debugInfo: {
      input: normalizedData,
      bmrFormula: gender === 'maschio' ? 'Harris-Benedict Male' : 'Harris-Benedict Female',
      activityFactor,
      goalFactor,
      finalMultiplier: activityFactor * goalFactor,
      expectedAndrea: Math.round(1692 * 1.375 * 0.85)
    }
  };
}

function normalizeFormDataWithAllergies(formData: FormData) {
  console.log('üîß ===== NORMALIZZAZIONE DATI CON ALLERGIE - DEBUG COMPLETO =====');
  console.log('üî• FormData INPUT:', JSON.stringify(formData, null, 2));
  
  const age = parseInt(String(formData.eta || '30')) || 30;
  console.log('üë∂ Et√† normalizzata:', formData.eta, '‚Üí', age);
  
  const weightStr = String(formData.peso || '70').replace(',', '.');
  const weight = parseFloat(weightStr) || 70;
  console.log('‚öñÔ∏è Peso normalizzato:', formData.peso, '‚Üí', weightStr, '‚Üí', weight);
  
  const heightStr = String(formData.altezza || '170').replace(',', '.');
  const height = parseFloat(heightStr) || 170;
  console.log('üìè Altezza normalizzata:', formData.altezza, '‚Üí', heightStr, '‚Üí', height);
  
  const genderRaw = String(formData.sesso || 'maschio').toLowerCase();
  const gender = (genderRaw.includes('uomo') || genderRaw.includes('maschio')) ? 'maschio' : 'femmina';
  console.log('üë´ Sesso normalizzato:', formData.sesso, '‚Üí', genderRaw, '‚Üí', gender);
  
  const activity = normalizeActivity(formData.attivita);
  console.log('üèÉ‚Äç‚ôÇÔ∏è Attivit√† normalizzata:', formData.attivita, '‚Üí', activity);
  
  const goal = normalizeGoal(formData.obiettivo);
  console.log('üéØ Obiettivo normalizzato:', formData.obiettivo, '‚Üí', goal);
  
  const numDays = parseInt(String(formData.durata || '3')) || 3;
  console.log('üìÖ Giorni normalizzati:', formData.durata, '‚Üí', numDays);
  
  const numMeals = parseInt(String(formData.pasti || '3')) || 3;
  console.log('üçΩÔ∏è Pasti normalizzati:', formData.pasti, '‚Üí', numMeals);

  // üö´ NORMALIZZAZIONE ALLERGIE
  const allergie = Array.isArray(formData.allergie) ? 
    formData.allergie.filter(a => a && a.trim()) : 
    [];
  console.log('üö´ Allergie normalizzate:', formData.allergie, '‚Üí', allergie);

  // ü•ó NORMALIZZAZIONE PREFERENZE
  const preferenze = Array.isArray(formData.preferenze) ? 
    formData.preferenze.filter(p => p && p.trim()) : 
    [];
  console.log('ü•ó Preferenze normalizzate:', formData.preferenze, '‚Üí', preferenze);

  // üéØ MODALIT√Ä
  const modalita = formData.modalita || 'guidata';
  console.log('üéØ Modalit√† normalizzata:', formData.modalita, '‚Üí', modalita);

  // üí™ DATI MODALIT√Ä ESPERTO
  const calorie_totali = formData.modalita === 'esperto' ? 
    parseFloat(formData.calorie_totali || '0') || undefined : undefined;
  const proteine_totali = formData.modalita === 'esperto' ? 
    parseFloat(formData.proteine_totali || '0') || undefined : undefined;
  const carboidrati_totali = formData.modalita === 'esperto' ? 
    parseFloat(formData.carboidrati_totali || '0') || undefined : undefined;
  const grassi_totali = formData.modalita === 'esperto' ? 
    parseFloat(formData.grassi_totali || '0') || undefined : undefined;

  const result = {
    age: Math.max(15, Math.min(100, age)),
    weight: Math.max(40, Math.min(200, weight)),
    height: Math.max(140, Math.min(220, height)),
    gender,
    activity,
    goal,
    numDays: Math.max(1, Math.min(14, numDays)),
    numMeals: Math.max(2, Math.min(7, numMeals)),
    allergie,
    preferenze,
    modalita,
    calorie_totali,
    proteine_totali,
    carboidrati_totali,
    grassi_totali
  };
  
  console.log('üì§ DATI NORMALIZZATI FINALI CON ALLERGIE:', JSON.stringify(result, null, 2));
  console.log('üîß ===== FINE NORMALIZZAZIONE =====');
  
  return result;
}

// üîß MAPPING ATTIVIT√Ä COMPLETAMENTE FIXATO
function normalizeActivity(activity: string): string {
  const activityMap: { [key: string]: string } = {
    // Valori diretti dal form
    'sedentario': 'sedentario',
    'leggero': 'leggero',              // ‚Üê FIX PRINCIPALE!
    'moderato': 'moderato',
    'intenso': 'intenso',
    'molto_intenso': 'molto_intenso',
    
    // Varianti con maiuscole
    'Sedentario': 'sedentario',
    'Leggero': 'leggero',
    'Moderato': 'moderato',
    'Intenso': 'intenso',
    
    // Varianti complete
    'Attivit√† Sedentaria': 'sedentario',
    'Attivit√† Leggera': 'leggero',        // ‚Üê FIX PRINCIPALE!
    'Attivit√† Moderata': 'moderato',
    'Attivit√† Intensa': 'intenso',
    'Attivit√† Molto Intensa': 'molto_intenso',
    
    // Varianti minuscole
    'attivit√† sedentaria': 'sedentario',
    'attivit√† leggera': 'leggero',
    'attivit√† moderata': 'moderato',
    'attivit√† intensa': 'intenso',
    'attivit√† molto intensa': 'molto_intenso',
    
    // Varianti alternative
    'bassa': 'sedentario',
    'media': 'moderato',
    'alta': 'intenso'
  };
  
  const normalized = activityMap[activity] || activityMap[String(activity || '').toLowerCase()] || 'leggero';
  console.log('üèÉ‚Äç‚ôÇÔ∏è Activity normalized:', activity, '‚Üí', normalized);
  return normalized;
}

// üîß MAPPING OBIETTIVO COMPLETAMENTE FIXATO
function normalizeGoal(goal: string): string {
  const goalMap: { [key: string]: string } = {
    // Valori diretti dal form - CORRETTI PER I TUOI 3 PARAMETRI
    'dimagrimento': 'dimagrimento',
    'mantenimento': 'mantenimento',
    'aumento-massa': 'aumento-massa',
    
    // Varianti con maiuscole
    'Dimagrimento': 'dimagrimento',
    'Mantenimento': 'mantenimento',          // ‚Üê FIX PRINCIPALE!
    'Aumento-massa': 'aumento-massa',
    
    // Varianti alternative
    'perdita-peso': 'dimagrimento',
    'perdita peso': 'dimagrimento',
    'perdita di peso': 'dimagrimento',
    'perdere peso': 'dimagrimento',
    'dimagrire': 'dimagrimento',
    
    'mantenere': 'mantenimento',
    'maintain': 'mantenimento',
    
    'aumento massa': 'aumento-massa',
    'massa': 'aumento-massa',
    'bulk': 'aumento-massa',
    'crescita': 'aumento-massa'
  };
  
  const normalized = goalMap[goal] || goalMap[String(goal || '').toLowerCase()] || 'mantenimento';
  console.log('üéØ Goal normalized:', goal, '‚Üí', normalized);
  return normalized;
}